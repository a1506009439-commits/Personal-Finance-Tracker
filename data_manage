# data_manager.py

import csv
from transaction_model import Transaction

DATA_FILE = 'transactions.csv'

def save_transaction(transaction: Transaction):
    """å°†ä¸€ç¬”äº¤æ˜“è®°å½•è¿½åŠ åˆ°CSVæ–‡ä»¶ä¸­"""
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå†³å®šæ˜¯å¦å†™å…¥è¡¨å¤´
    file_exists = False
    try:
        with open(DATA_FILE, 'r') as f:
            file_exists = True
    except FileNotFoundError:
        pass

    with open(DATA_FILE, 'a', newline='', encoding='utf-8') as file:
        fieldnames = ['id', 'date', 'amount', 'type', 'category', 'description']
        writer = csv.DictWriter(file, fieldnames=fieldnames)
        
        # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™å†™å…¥è¡¨å¤´
        if not file_exists:
            writer.writeheader()
        
        writer.writerow(transaction.to_dict())
        print(f"âœ… äº¤æ˜“è®°å½•å·²ä¿å­˜: {transaction.description}")


def load_transactions() -> list[Transaction]:
    """ä»CSVæ–‡ä»¶åŠ è½½æ‰€æœ‰äº¤æ˜“è®°å½•å¹¶è¿”å›åˆ—è¡¨"""
    transactions = []
    try:
        with open(DATA_FILE, 'r', encoding='utf-8') as file:
            reader = csv.DictReader(file)
            for row in reader:
                transactions.append(Transaction.from_dict(row))
    except FileNotFoundError:
        print(f"âš ï¸ æç¤ºï¼šæ–‡ä»¶ {DATA_FILE} ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºåˆ—è¡¨ã€‚")
        pass 
        
    return transactions


def calculate_total_balance() -> float:
    """è®¡ç®—æ‰€æœ‰äº¤æ˜“è®°å½•çš„æ€»ä½™é¢"""
    all_transactions = load_transactions()
    total_balance = sum(t.amount for t in all_transactions)
    return total_balance


# ----------------------------------------------------------------------
# æµ‹è¯•/è¿è¡Œä»£ç å—
# ----------------------------------------------------------------------
if __name__ == '__main__':
    # 1. æ¨¡æ‹Ÿå¹¶ä¿å­˜äº¤æ˜“
    print("--- 1. æ­£åœ¨ä¿å­˜æµ‹è¯•æ•°æ® ---")
    
    # æ¸…ç©ºæ–‡ä»¶ (æ–¹ä¾¿æµ‹è¯•æ—¶é‡æ–°å¼€å§‹)
    open(DATA_FILE, 'w').close()

    # æ¨¡æ‹Ÿä¸¤ç¬”æ”¯å‡ºå’Œä¸€ç¬”æ”¶å…¥
    expense_1 = Transaction(id=1, date="2025-12-09", amount=-35.50, type="æ”¯å‡º", category="é£Ÿç‰©", description="å’–å•¡å’Œé¢åŒ…")
    expense_2 = Transaction(id=2, date="2025-12-09", amount=-150.00, type="æ”¯å‡º", category="äº¤é€š", description="åœ°é“å¡å……å€¼")
    income = Transaction(id=3, date="2025-12-09", amount=5000.00, type="æ”¶å…¥", category="å·¥èµ„", description="æœˆè–ª")
    
    save_transaction(expense_1)
    save_transaction(expense_2)
    save_transaction(income)
    
    # 2. è¯»å–æ‰€æœ‰äº¤æ˜“å¹¶æ‰“å°
    print("\n--- 2. è¯»å–æ‰€æœ‰äº¤æ˜“ ---")
    all_transactions = load_transactions()
    for t in all_transactions:
        print(f"| ID: {t.id}, æ—¥æœŸ: {t.date}, é‡‘é¢: {t.amount}, åˆ†ç±»: {t.category}")

    # 3. è®¡ç®—æ€»ä½™é¢
    print("\n--- 3. è®¡ç®—å½“å‰æ€»ä½™é¢ ---")
    current_balance = calculate_total_balance()
    print(f"ğŸ’° **å½“å‰æ€»ä½™é¢æ˜¯: {current_balance:.2f} å…ƒ**")
